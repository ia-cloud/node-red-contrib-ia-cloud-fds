# チョコ停ウォッチャーノード

## 機能概要

チョコ停ウォッチャーは、生産現場で搬送ラインなどをカメラで撮影し、異常があったタイミングの映像を後から確認できるように記録するための製品である。異常のあったタイミングは、トリガーと呼ぶ信号をチョコ停ウォッチャーに入力することで伝える。トリガーが入力されると、トリガーの入力タイミング前後の録画データをロックファイルとして保存する。また、チョコ停ウォッチャーと接続したPCでブラウザからチョコ停ウォッチャーViewer(チョコ停ウォッチャーのネットワークアドレス)にアクセスすることで、チョコ停ウォッチャーの設定変更や録画されたデータを閲覧することができる。<br>
チョコ停ウォッチャーノードは、チョコ停ウォッチャーから録画データや静止画データを読み出し、ia-cloudオブジェクトを生成するノードである。


## 機能詳細

### ロックファイルチェック機能

チョコ停ウォッチャーに保存された録画データ(ロックファイル)を設定周期毎にチェックする。ロックファイルが存在した場合、すべてのロックファイルについてia-cloudファイルデータオブジェクト形式に変換して出力する*1 と共に、チョコ停ウォッチャーから削除する。<br>
また、動画ファイル取得中にフローをデプロイすることは想定しておらず、誤動作の原因となる可能性がある。<br>
ロックファイルのチェック周期は、以下の2種類から選択できる。

#### -都度チェック

10秒毎にチョコ停ウォッチャーのロックファイルをチェックする。

#### -定期チェック

6、12、24時間のいずれかの設定周期でチョコ停ウォッチャーのロックファイルをチェックする。

### 静止画取得機能

チョコ停ウォッチャーから静止画データを取得する。
静止画は定期、もしくはメッセージ入力時に取得できる。<br>
また、静止画データはia-cloudファイルデータオブジェクト、ローカルモニタ用静止画出力、その両方で出力できる。

#### 静止画取得タイミング

#### -定期取得

10、30分、1、3、6、12、24時間のいずれかの設定周期で、チョコ停ウォッチャーから静止画データを取得し、出力できる。

#### -入力メッセージによる静止画取得

msg.getImageがNULL、0、false 以外で入力された場合に、チョコ停ウォッチャーから静止画データを取得し、出力できる。定期取得に設定している場合も、msg.getImageが入力された場合は同様に動作する。

#### 静止画データ出力形式

#### -静止画のia-cloudデータオブジェクト出力

「静止画出力」プロパティが「ia-cloud格納」か「両方」に設定されている場合、チョコ停ウォッチャーから取得した静止画データをia-cloudデータオブジェクトで出力する。*1


#### -ローカルモニタ用静止画出力

「静止画出力」プロパティが「ローカルモニタ出力」か「両方」に設定されている場合、チョコ停ウォッチャーから取得された静止画について、Base64形式のデータをノードの2番目の出力からmsg.payloadとして出力する。*2<br>
ノードの2番目の出力は、「静止画出力」プロパティで「ローカルモニタ出力」か「両方」を選択した場合に接続できるようになる。<br>
「template」ノードと接続して静止画表示をする場合、「template」ノードの「HTMLコード」を以下のように設定する。
```
<html><body><img src="data:image/jpg;base64,{{msg.payload}}" width="100%"></body></html>
```

### チョコ停ウォッチャーの設定機能

「本体の設定」タブからチョコ停ウォッチャーの「PC時刻同期」、「録画モード」、「録画単位」、「スピーカー音量」、「カメラアングル」の設定を変更することができる。Node-REDで既存の設定を確認することはできない。設定変更はフローをデプロイすることでチョコ停ウォッチャーと接続された場合に反映される。デプロイ時にチョコ停ウォッチャーとの接続ができない場合、設定が反映されない。<br>
また、設定変更はブラウザをリロードすることで、チョコ停ウォッチャーViewerの設定表示に反映される。

### チョコ停ウォッチャー監視機能

10秒ごとに、エラーコードとアラーム状態を取得する。「アラーム＆イベントを出力する」プロパティがチェックされていれば、エラーコードが変化した時、またはアラーム状態が1の時にia-cloudアラーム＆イベントデータオブジェクトを出力する。*1

## 入力メッセージ

入力メッセージには、チョコ停ウォッチャーがロックファイルを保存するためのトリガー送出を指示するメッセージと静止画取得のタイミングを指示するメッセージの2つがある。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|msg.trigger|boolean/string/number/object|NULL、0、false 以外の時、チョコ停ウォッチャーへトリガーコマンドを入力する。チョコ停ウォッチャーがトリガーを受信すると、ロックファイルが保存される。| 
|msg.getImage|boolean/string/number/object|NULL、0、false 以外の時、チョコ停ウォッチャーから静止画データを取得し、「静止画出力」プロパティの設定に応じた形式で出力する。| 

## *1: 出力メッセージ1

ノードの1番目の出力からの出力メッセージは、ia-cloudファイルデータオブジェクトとそれをia-cloud CSへ格納するためのリクエストを含む。ia-cloud-cnctノードへの接続を想定しており、ia-cloud CSへ格納するためのbase64形式の動画データは、Node-RED動作環境のtemp-dir-ia-cloudディレクトリに保存される。


| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|msg.request|string|ia-cloud APIのリクエスト。"store"固定。|
|msg.dataObject|object|格納するia-cloudデータオブジェクト| 

#### msgオブジェクトの構成例(ia-cloudファイルデータオブジェクトの場合)

```
{
    "request": "store", //ia-cloud APIのrequest。"store"固定。
    "dataObject": {
        "objectType": "iaCloudObject", //ia-cloudオブジェクト
        "objectContent": {
            "contentType": "Filedata",
            "contentData": [
                {
                    "commonName": "File Name",
                    "dataValue": "ファイル名"
                },
                {
                    "commonName": "MIME Type",
                    "dataValue": "MIMEタイプ" //動画ファイルの場合は"video/quicktime"、画像ファイルは"image/jpeg"
                },
                {
                   "commonName": "Encoding",
                    "dataValue": "base64" 
                },
                {
                    "commonName": "Size",
                    "dataValue": サイズ
                },
                {
                    "commonName": "file path",
                    "dataValue": "ファイルパス"
                }
            ],
        "objectKey": "オブジェクトキー", //ia-cloudオブジェクトキー
        "objectDescription": "オブジェクト説明", //ia-cloudオブジェクトの説明
        "timestamp": "タイムスタンプ",
        "_msgid": "メッセージID"
        }
    }
}
```

#### msgオブジェクトの構成例(ia-cloudアラーム＆イベントデータオブジェクトの場合)
```
{
    "request": "store", //ia-cloud APIのrequest。"store"固定。
    "dataObject": {
        "objectType": "iaCloudObject", //ia-cloudオブジェクト
        "objectContent": {
            "contentType": "Alarm&Event",
            "contentData": [
                {
                    "commonName": "runningStatus",
                    "dataValue": {
                        "AnEStatus": "アラーム&イベントの更新状態", //変更されていれば"set"、されていなければ"on"
                        "AnEcode": "エラーコード"
                    }
                },
                {
                    "commonName": "errorStatus",
                    "dataValue": {
                        "AnEStatus": "アラーム&イベントの更新状態",
                        "AnEcode": "エラーコード",
                        "AnEDescription": "エラーステータス表示"
                    }
                },
                {
                    "commonName": "alertStatus",
                    "dataValue": {
                        "AnEStatus": "アラーム&イベントの更新状態",
                        "AnEcode": "エラーコード"
                    }
                }
            ],
        "objectKey": "オブジェクトキー", //ia-cloudオブジェクトキー
        "objectDescription": "オブジェクト説明", //ia-cloudオブジェクトの説明
        "timestamp": "タイムスタンプ",
        "_msgid": "メッセージID"
        }
    }
}
```

## *2: 出力メッセージ2

ノードの2番目の出力は、チョコ停ウォッチャーから取得した静止画を出力する。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|msg.payload|string|MIME type が image/jpeg のBase64形式の静止画データ|

## プロパティ

本ノードは以下のプロパティを持つ。

| 名称 | 種別 | 説明 | 備考 |
|:----------|:-----:|:-----|:-------|
|ネットワークアドレス|string|接続するチョコ停ウォッチャーのネットワークアドレス|
|ノード名称|string|本ノードの名称|
|configReady|boolean|必須のプロパティがすべて設定済みかを表すフラグ|非表示のプロパティ|

**本体の設定タブ**<br>
チョコ停ウォッチャーの設定を変更するためのプロパティ。
「PC時刻同期」以外の項目は、セレクトボックスによる選択である。選択肢の「本体のまま」は、チョコ停ウォッチャーの既存の設定を変更しない。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|PC時刻同期|boolean| 起動時、または100秒ごとにチョコ停ウォッチャーの時計を接続したPCと同期する場合にチェックする。|
|録画モード|string| 「トリガーオンリー」、「ループ&トリガーロック」、「本体のまま」のいずれか。チョコ停ウォッチャーは、「トリガーオンリー」の場合には動画を本体の内部メモリに一時記録し、トリガーを受信するとトリガータイミングを中心とした1つのロックファイルをSDカードに保存する。「ループ&トリガーロック」の場合には、動画を設定した録画単位ごとにSDカードに保存し、トリガーを受信するとトリガータイミングの動画とその前後の3つの動画をロックファイルとして保存する。　|
|録画単位|string| 「トリガーオンリー」モードの場合、「20秒」、「40秒」、「本体のまま」のいずれか。「ループ&トリガーロック」モードの場合、「1分」、「3分」、「5分」、「10分」、「本体のまま」のいずれか。|
|スピーカー音量|string| チョコ停ウォッチャーのスピーカーの設定音量。「大」、「中」、「小」、「OFF」、「本体のまま」のいずれか。|
|カメラアングル|string| チョコ停ウォッチャーのカメラアングル。「110度」、「180度」、「本体のまま」のいずれか。|

**機能の設定タブ**<br>
ロックファイルチェック機能、静止画取得機能について設定するためのプロパティ。
各項目とも、セレクトボックスによる選択である。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|チェック周期|string| 「都度チェック」、「定期チェック」のいずれか。|
|チェック周期単位|string| 「定期チェック」の場合に選択できる。「6時間」、「12時間」、「24時間」のいずれか。|
|静止画出力|string| 静止画の出力先。「無し」、「ia-cloudオブジェクト出力」、「ローカルモニタ出力」、「両方」のいずれか。<br>「無し」を選択した場合、チョコ停ウォッチャーから静止画データを取得しない。<br>「ローカルモニタ出力」か「両方」を選択した場合、ノードの2番目の出力への接続が可能。|
|静止画取得周期|string| 静止画データを取得する場合の周期。「msg.getImage入力による取得のみ」、「10分」、「30分」、「1時間」、「3時間」、「6時間」、「12時間」、「24時間」のいずれか。|

**オブジェクトの設定タブ**<br>
オブジェクトの内容を設定するためのプロパティ。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|オブジェクトキー|string| ia-cloudオブジェクトのobjectKeyとして利用。|
|オブジェクトの説明|string| ia-cloudオブジェクトのobjectDescriptionとして利用。|
|アラーム＆イベントを出力する|boolean| チョコ停ウォッチャーとのエラー情報をia-cloudアラーム＆イベントデータオブジェクトとして出力する場合にチェックを入れる。|
|A&Eのオブジェクトキー|string|ia-cloudアラーム＆イベントデータオブジェクトのobjectKeyとして利用。|
|A&Eのオブジェクトの説明|string|ia-cloudアラーム＆イベントデータオブジェクトのobjectDescriptionとして利用。|
