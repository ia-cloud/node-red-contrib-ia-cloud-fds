# 因幡電機産業チョコ停ウォッチャーノード

## 機能詳細
因幡電機産業チョコ停ウォッチャーの録画データ等を読み出し、ia-cloudオブジェクトを生成するノード。

### 動画収集機能
チョコ停ウォッチャーの録画データ（ロックファイル）を監視し、設定応じてia-cloudファイルデータオブジェクトとして送出する。
#### -都度収集
設定間隔（1,10,30,60分のいずれか）でチョコ停ウォッチャーのロックファイルを監視し、新しいロックファイルが存在した場合にはia-cloudファイルデータオブジェクトを送出すると共に、ロックファイイルを削除する。
#### -定期収集
設定間隔（1,2,6,12,24時間のいずれか）ででチョコ停ウォッチャーのロックファイル情報を取得し、新しいロックファイルが存在した場合にはia-cloudファイルデータオブジェクトを送出すると共に、ロックファイイルを削除する。

### チョコ停ウォッチャー監視機能
固定周期（10秒）で、チョコ停ウォッチャーの以下の状態をモニタし、必要な動作を行う。
#### -エラーコード
GET /xaccja/getErrorCodeコマンドにてエラー状態を取得し、Node-REDステータス表示とデバッグペインへのメッセージ出力を行う。設定により、ia-cloudアラーム＆イベントデータオブジェクトを送出する。
#### -警報状態
GET /xaccja/getAlertStatusコマンドにてアラート状態を取得し、Node-REDステータス表示とデバッグペインへのメッセージ出力を行う。設定により、ia-cloudアラーム＆イベントデータオブジェクトを送出する。
#### -SDカードの残容量
GET /xaccja/getRemainingCapacityコマンドにてSDカードの残容量を取得し、残容量が設定を下回った場合設定応じて、以下の動作を行う。  
* ロックファイルを全て削除し、要領の解放を行う
* ia-cloudアラーム＆イベントデータオブジェクトを送出する。

### 静止画とカメラ情報定期収集機能
静止画とカメラ情報の定期収集の設定周期（10,30分、1,2,6,12,24時間のいずれか）が設定されている場合、その周期でチョコ停ウォッチャーから静止画データとカメラ情報やSDカード残容量を取得し、獅子がを含んだia-cloudファイルデータオブジェクトと、カメラ情報等を含んだia-cloudデータオブジェクトとを送出する。

### 入力メッセージによるトリガ機能
入力メッセージが以下の条件を満たす場合、それぞれの動作を実行する。
* msg.trigger が真の場合：チョコ停ウォッチャーに、トリガコマンド（POST /xaccja/setTrigger）を送出する。
* msg.getImageが真の場合：チョコ停ウォッチャーから、静止画取得コマンド（/xaccja/getCamImage）にて静止画を取得し、ia-cloudファイルデータオブジェクトを送出する。

### ローカルモニタ用静止画出力
モニタ用静止画定期収集の設定周期（10,30分、1,2,6,12,24時間のいずれか）が設定されている場合、その周期でチョコ停ウォッチャーから静止画を取得し、ノード2nd出力から、msg.payloadとして送出する。

## 入力メッセージ
チョコ停ウォッチャーのトリガーと静止画所得のタイミングを指示するメッセージ

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|trigger|boolean/string/number/object|NULL, 0, false 以外の時、チョコ停ウォッチャーへトリガーコマンドを送出する。| 
|getImage|boolean/string/number/object|NULL, 0, false 以外の時、チョコ停ウォッチャーから静止画を取得し、ia-cloudファイルデータオブジェクトを送出する。| 


## 出力メッセージ1
オブジェクトのia-cloud CSへストアーするためのメッセージを出力する。ia-cloud-cnct Nodeへの接続を想定している。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|request|string|"store"|
|dataObject|object|ストアするia-cloudオブジェクト|  

## 出力メッセージ2（オプション）
オブジェクトのia-cloud CSへストアーするためのメッセージを出力する。ia-cloud-cnct Nodeへの接続を想定している。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|payload|stream|MIME type image/jpeg の静止画データ| 

## プロパティー

本nodeは以下のプロパティを持つ

| 名称 | 種別 | 説明 | 備考 |
|:----------|:-----:|:-----|:-------|
|チョコ停ウォッチャーアドレス|string|接続するチョコ停ウォッチャーのネットワークアドレス|
|Node name|string|本ノードの名称|
|configReady|boolean|必須のプロパティがすべて設定済みかを表すフラグ|非表示のプロパティ

**タブ：チョコ停ウォッチャーの設定**
各項目とも、セレクトボックスによる選択である。選択肢の「不変」は、チョコ停ウォッチャーの既存の設定を変更しない。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|時刻同期|boolean| 起動時とロックファイル読み出し時に、チョコ停ウォッチャーの時計をNode-REDアプリケーションと同期する。　|
|録画モード|string| ループ&トリガーロック、トリガーオンリーのいずれか　|
|録画単位|string| トリガーオンリーモードの場合、20秒か40秒か不変。ループ&トリガーロックモードの場合、1,3,5,10分,不変のいずれか<　|
|スピーカ音量|string| チョコ停ウォッチャーのスピーカの設定音量、大、中、小、OFF、不変のいずれか　|
|カメラアングル|string| チョコ停ウォッチャーのカメラアングル。110度、180度、不変、のいずれか。|

**データ収集設定**
各項目とも、セレクトボックスによる選択である。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|動画収集方式|string| 都度収集・定期収集のいずれか　|
|動画収集周期|string| 定期収集の場合の収集周期、6,12,24時間のいずれか。|
|静止画出力方法|string| 静止画の出力先。無し・ia-cloudオブジェクト出力・ローカルモニタ出力・両方のいずれか。|
|静止画収集周期|string| 静止画定期収集する場合の周期。入力メッセージ、msg.triggerによる収集のみと、10,30分、1,3,6,12,24時間のいずれか。|

**オブジェクトの設定**

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|オブジェクトキー|string| ia-cloudオブジェクトのobjectKeyとして使われる。|
|オブジェクトの説明|string| ia-cloudオブジェクトのobjectdescriptionとして使われる。|
|品質情報|boolean| チョコ停ウォッチャーとの通信エラー時に品質情報を出力する場合にチェックを入れる。|
|収集ファイル名|string|収集する動画データにつけるファイル名のプリフィックス。空欄は、チョコ停ウォッチャーが使用するデフォルトのファイル名。指定されたファイル名の後ろにタイムスタンプで拡張された名称となる。|



